rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a room has any players
    // Note: This is a simplified check - counts all players regardless of active status
    // The client-side logic properly filters by active players before deletion
    // Firestore Rules syntax: must use expressions, not if statements
    function hasPlayers(room) {
      // Check for players array (Spy, Draw, Frequency games)
      // Even if players have active: false, we consider them as "players" in rules
      // Client logic will only delete when active players count is 0
      return (room.players != null && room.players is list && room.players.size() > 0) ||
             // Check for teams structure (Alias games) - simplified: check if teams array exists and has elements
             // Note: We can't loop, so we check if teams array exists and is non-empty
             // This is a best-effort check; client-side logic handles active player filtering
             (room.teams != null && room.teams is list && room.teams.size() > 0) ||
             // Check for Codenames team structures
             (room.red_team != null && 
              ((room.red_team.spymaster != null && room.red_team.spymaster != '') ||
               (room.red_team.guessers != null && room.red_team.guessers.size() > 0))) ||
             (room.blue_team != null && 
              ((room.blue_team.spymaster != null && room.blue_team.spymaster != '') ||
               (room.blue_team.guessers != null && room.blue_team.guessers.size() > 0)));
    }
    
    // Helper function to check if room is in a deletable state
    function isDeletable(room) {
      // Can delete if game is finished OR if no players remain
      // This allows cleanup when all players have left or game ends
      return room.game_status == 'finished' || !hasPlayers(room);
    }
    
    // Reference data collections - read-only for all
    match /WordCard/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of word cards
    }
    
    match /DrawWord/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of draw words
    }
    
    match /SpyLocation/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of spy locations
    }
    
    match /FrequencyTopic/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of frequency topics
    }
    
    // GameRoom (Alias Game)
    match /GameRoom/{roomId} {
      // Allow reads - needed to join and play
      allow read: if true;
      
      // Allow creates - validate basic structure
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      // Allow updates - needed for gameplay, validate structure
      allow update: if resource != null && // Room must exist
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      // Allow deletes only in safe conditions (prevents deleting active games)
      allow delete: if resource != null && isDeletable(resource.data);
    }
    
    // CodenamesRoom
    match /CodenamesRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow delete: if resource != null && isDeletable(resource.data);
    }
    
    // DrawRoom
    match /DrawRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow delete: if resource != null && isDeletable(resource.data);
    }
    
    // SpyRoom
    match /SpyRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow delete: if resource != null && isDeletable(resource.data);
    }
    
    // FrequencyRoom
    match /FrequencyRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string;
      
      allow delete: if resource != null && isDeletable(resource.data);
    }
    
    // Default deny for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

