rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reference data collections - read-only for all
    match /WordCard/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of word cards
    }
    
    match /DrawWord/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of draw words
    }
    
    match /SpyLocation/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of spy locations
    }
    
    match /FrequencyTopic/{document=**} {
      allow read: if true;
      allow write: if false; // Prevent modification of frequency topics
    }
    
    // GameRoom (Alias Game)
    match /GameRoom/{roomId} {
      // Allow reads - needed to join and play
      allow read: if true;
      
      // Allow creates - validate basic structure and expires_at field
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at is timestamp;
      
      // Allow updates - needed for gameplay, validate structure
      // Note: expires_at should not be modified after creation (TTL is set at creation)
      allow update: if resource != null && // Room must exist
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at == resource.data.expires_at; // expires_at cannot be changed
      
      // Allow deletes - simple check, TTL handles automatic deletion via expires_at
      allow delete: if resource != null;
    }
    
    // CodenamesRoom
    match /CodenamesRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at is timestamp;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at == resource.data.expires_at; // expires_at cannot be changed
      
      // Allow deletes - simple check, TTL handles automatic deletion via expires_at
      allow delete: if resource != null;
    }
    
    // DrawRoom
    match /DrawRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at is timestamp;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at == resource.data.expires_at; // expires_at cannot be changed
      
      // Allow deletes - simple check, TTL handles automatic deletion via expires_at
      allow delete: if resource != null;
    }
    
    // SpyRoom
    match /SpyRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at is timestamp;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at == resource.data.expires_at; // expires_at cannot be changed
      
      // Allow deletes - simple check, TTL handles automatic deletion via expires_at
      allow delete: if resource != null;
    }
    
    // FrequencyRoom
    match /FrequencyRoom/{roomId} {
      allow read: if true;
      
      allow create: if request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at is timestamp;
      
      allow update: if resource != null &&
                      request.resource.data.room_code is string &&
                      request.resource.data.host_name is string &&
                      request.resource.data.game_status is string &&
                      request.resource.data.expires_at == resource.data.expires_at; // expires_at cannot be changed
      
      // Allow deletes - simple check, TTL handles automatic deletion via expires_at
      allow delete: if resource != null;
    }
    
    // Default deny for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
